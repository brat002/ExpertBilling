<script>
	var obj_arr = new Array();
	var tariff = {{ tariff.id }};
	{% for tariff_object in tariff_objects  %}
		obj_arr[{{ tariff_object.from_tariff.id }}] = new Array();
		obj_arr[{{ tariff_object.from_tariff.id }}][{{ tariff_object.to_tariff.id }}] = new Array({{ tariff_object.ballance_min }}, {{ tariff_object.cost }}, {{ tariff_object.oldtptime }});
	{% endfor %}
	
	
	function change_tariff() {
		var new_tariff = document.getElementById("id_tariff_id");
		var message=document.getElementById("error_message");
		var message=document.getElementById("ok_message");
	 	jQuery.ajax({
        	type: "POST",
        	cache: false,
        	url: '/tariff/change/',
        	data: {'old_tariff':tariff, 'id_tariff_id':new_tariff.value},
        	timeout: 15000,
			contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
        	success: function(data, status){
				var ret = eval('('+data+')');
				if (typeof ret['ok_message'] != 'undefined') {
					tb_remove();
				} else {
					message.innerHTML = ret['error_message'];
				}
			},
        	error: function(data, status){
				var ret = eval('('+data+')'); 
				message.innerHTML = ret['error_message'];
			 },
        	complete: function(data, status){  }
    	});
	}
	
	function set_cost() {
		var new_tariff = document.getElementById("id_tariff_id");
		var need_ballance = document.getElementById("need_ballance");
		var need_cost = document.getElementById("need_cost");
		var error_message = document.getElementById("error_message");
		var send_button = document.getElementById("send_button");
		try {
			var ballance = eval('obj_arr[{{ tariff.tarif.id }}]['+new_tariff.value+'][0]');
			var seconds = eval('obj_arr[{{ tariff.tarif.id }}]['+new_tariff.value+'][2]');
			var price = ballance+{{ user.ballance }};
			if (price <= 0) {
				need_ballance.innerHTML = '<h2>'+ballance+'</h2>';
			} else {
				need_ballance.innerHTML = '<h2 class="red">'+ballance+'</h2>';
				send_button.style.visibility = 'hidden';
			}
			need_cost.innerHTML = '<h2>'+eval('obj_arr[{{ tariff.tarif.id }}]['+new_tariff.value+'][1]')+'</h2>';
			error_message.innerHTML = '';
			send_button.style.visibility = 'visible';
			if ({{ time }} < seconds) {
				error_message.innerHTML = '<div class="red">Вы мало пользовались предыдущим тарифным планом!</div>';
				send_button.style.visibility = 'hidden'; 
			}
			return true;
		} catch(err) {
			error_message.innerHTML = '<div class="red">Вы не можите перейти на данный тарифный план</div>';
			need_cost.innerHTML = '<h2>0</h2>';
			need_ballance.innerHTML = '<h2>0</h2>';
			send_button.style.visibility = 'hidden';
		}
		
	}
</script>

<div class="cs_tb_header">
	<a href="javascript://" onclick="tb_remove()" class="cs_tb_close"></a>
</div>

<div>

{% if form %}
<div class="pass_table_margin_top">
	<form method="post" onsubmit="return false;">
		<table class="pass_table wide" cellpadding="0" cellspacing="0">
			<tr>
				<th class="blue_caption white s-11 bold main_table_left_border right_border">
					СМЕНА ТАРИФА
				</th>
			</tr>
			<tr>
				<td>
					<table cellpadding="5px;" class="enter_table">
	    					{{ form }}
							<tr>
								<th>
									Стоимость перехода на данный тарифный план составит:	
								</th>
								<td align="center">
									<div id="need_cost"><h2>0</h2></div>
								</td>
							</tr>
							<tr>
								<th>
									Необходимый минимум на балансе: 
								</th>
								<td align="center">
									<div id="need_ballance"><h2>0</h2></div>
								</td>
							</tr>
					</table>
				</td>
			</tr>
		</table>
		<div id="error_message" class="a-center"></div>
		<!--<div id="ok_message" class="a-center"></div>-->
		<input id="send_button" type="image" src="{{ MEDIA_URL }}img/design/pass_button.gif" class="pass_button button_margin" onclick="change_tariff()"/>
	</form>
</div>
{% endif %}
</div>