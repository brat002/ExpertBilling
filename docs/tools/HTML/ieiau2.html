<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <title>Примеры</title>
   <meta name="generator" content="Help &amp; Manual" />
   <meta name="keywords" content="" />
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
   <meta http-equiv="Content-Style-Type" content="text/css" />
   <link type="text/css" href="default.css" rel="stylesheet" />
<script type="text/javascript" src="helpman_topicinit.js"></script></head>
<body style="margin: 0px 0px 0px 0px; background: #FFFFFF;">
<div id="hmpopupDiv" style="visibility:hidden; position:absolute; z-index:1000; "></div>


<table width="100%" border="0" cellspacing="0" cellpadding="5" bgcolor="#C0C0C0">
  <tr valign="middle">
    <td align="left">
      <p class="par3"><span class="fnt4">Примеры</span></p>

    </td>
    <td align="right">
     <span style="font-size: 9pt">
     <a href="chapter_2.html">Top</a>&nbsp;
     <a href="iaciaaiea_e_iniaaiiinoe14.html">Previous</a>&nbsp;
     <a href="new_item13.html">Next</a>
     </span>
    </td>
  </tr>
</table>


<!-- Placeholder for topic body. -->
<table width="100%" border="0" cellspacing="0" cellpadding="5"><tr valign="top"><td align="left">
<p class="par3"><span class="fnt4" style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">Увеличение скорости в 2 раза на 24 часа</span></p>
<p class="par3"><span class="fnt4">&nbsp;</span></p>
<p style="text-align: center;"><img src="addonservice_ex_1.png" width="433" height="686" alt="addonservice_ex_1" style="border:none" /></p>
<p class="par3"><span class="fnt4">&nbsp;</span></p>
<p class="par3"><span class="fnt4" style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">Добровольная блокировка лицевого счёта</span></p>
<p style="text-align: justify;">&nbsp;</p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">Для начала в каталоге scripts/ биллинг-системы нужно создать скрипт на языке python и назвать его enable_disable.py</span></p>
<p style="text-align: justify;">&nbsp;</p>
<p><span style="font-family: 'Courier New';">#!/usr/bin/env python</span></p>
<p>&nbsp;</p>
<p><span style="font-family: 'Courier New';">import psycopg2</span></p>
<p><span style="font-family: 'Courier New';">import sys</span></p>
<p><span style="font-family: 'Courier New';">import ConfigParser</span></p>
<p><span style="font-family: 'Courier New';">import psycopg2, psycopg2.extras</span></p>
<p><span style="font-family: 'Courier New';">from DBUtils.PooledDB import PooledDB</span></p>
<p><span style="font-family: 'Courier New';">from DBUtils.PersistentDB import PersistentDB</span></p>
<p>&nbsp;</p>
<p><span style="font-family: 'Courier New';">try:</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;config = ConfigParser.ConfigParser()</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;config.read("/opt/ebs/data/ebs_config.ini")</span></p>
<p>&nbsp;</p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;persist = PersistentDB(</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp; &nbsp; &nbsp;setsession=["SET synchronous_commit TO ON;", 'SET DATESTYLE TO ISO;'],</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp; &nbsp; &nbsp;creator=psycopg2,</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp; &nbsp; &nbsp;dsn="dbname='%s' user='%s' host='%s' password='%s'" % (config.get("db", "name"), config.get("db", "username"),.</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; config.get("db", "host"), config.get("db", "password")))</span></p>
<p>&nbsp;</p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;connection = persist.connection()</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;cur = connection.cursor()</span></p>
<p>&nbsp;</p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;if sys.argv[1]=='enable':</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp; &nbsp; &nbsp;cur.execute("UPDATE billservice_account SET status = 1 WHERE id=%s" % sys.argv[2])</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;elif sys.argv[1]=='disable':</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp; &nbsp; &nbsp;cur.execute("UPDATE billservice_account SET status = 2 WHERE id=%s" % sys.argv[2])</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;cur.connection.commit()</span></p>
<p><span style="font-family: 'Courier New';">except Exception, e:</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;fd = open('/opt/ebs/data/log/errors.log', 'a+')</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;fd.write(str(e))</span></p>
<p><span style="font-family: 'Courier New';"> &nbsp; &nbsp;fd.close()</span></p>
<p style="text-align: justify;">&nbsp;</p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; font-style: italic; color: #ff0000;">Внимание!!! Сохраните все отступы в приведённом скрипте!</span></p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">Скрипт принимает в качестве первого параметра требуемое действие, в качестве второго параметра id абонента.</span></p>
<p style="text-align: justify;">&nbsp;</p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">После этого нужно установить недостающие библиотеки</span></p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;"># apt-get install python-psycopg2 python-setuptools</span></p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;"># easy_install DBUtils</span></p>
<p style="text-align: justify;">&nbsp;</p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">Теперь проверим правильность работы скрипта</span></p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">1. Возьмём id произвольного абонента в системе</span></p>
<p style="text-align: center;"><img src="account_id_inactive.png" width="191" height="106" alt="account_id_inactive" style="border:none" /></p>
<p style="text-align: center;"><span style="font-size: 16px; font-family: 'Times New Roman'; font-style: italic; color: #000000;">Идентификаторы абонентов</span></p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">2. Выполним из консоли скрипт с нужными параметрами </span></p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;"># python enable_disable.py disable 9</span></p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">В случае успешного выполнения скрипта пользователь test должен стать неактивным в системе.</span></p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman'; color: #000000;">Если этого не произошло - смотрите лог-файл </span><span class="fnt3" style="font-size: 16px; font-family: 'Times New Roman';">/opt/ebs/data/log/errors.log </span><span style="font-size: 16px; font-family: 'Times New Roman';">на предмет ошибок</span><span class="fnt3" style="font-size: 16px; font-family: 'Times New Roman';">.</span></p>
<p style="text-align: justify;">&nbsp;</p>
<p><span style="font-size: 16px; font-family: 'Times New Roman';">Теперь создадим разовую подключаемую услугу, которая заблокирует аккаунт абонента на месяц, но для начала добавим в систему сервер доступа, на котором работает биллинг-система(так как команды требуется выполнять именно на нём).</span></p>
<p>&nbsp;</p>
<p style="text-align: center;"><img src="nas_localhost.png" width="416" height="550" alt="nas_localhost" style="border:none" /></p>
<p style="text-align: center;"><span style="font-size: 16px; font-family: 'Times New Roman'; font-style: italic;">Локальный сервер</span></p>
<p style="text-align: center;">&nbsp;</p>
<p style="text-align: justify;"><span style="font-size: 16px; font-family: 'Times New Roman';">Обязательно нажмите на кнопку "Test" и проверьте правильность введённых данных. В данной конфигурации поля "Сетевое имя" и "Секретная фраза" не имеют никакого значения, однако обязательны для заполнения в рамках условий для настроек серверов доступа.</span></p>
<p style="text-align: justify;">&nbsp;</p>
<p style="text-align: center;"><img src="addonservice_enable_disable.png" width="433" height="686" alt="addonservice_enable_disable" style="border:none" /></p>
<p style="text-align: center;"><span style="font-size: 16px; font-family: 'Times New Roman'; font-style: italic;">Параметры подключаемой услуги</span></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px; font-family: 'Times New Roman';">В полях "Активировать услугу" и "Деактивровать услугу" указаны соответствующие параметры для скрипта и в качестве ID абонента передана переменная $user_id</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<hr noshade="noshade" size="1" /><p>This help file was created with an unregistered evaluation copy of Help &amp; Manual. © EC Software. All rights reserved. This message will not appear if you compile this help file with the registered version of Help &amp; Manual.</p>

</td></tr></table>

</body>
</html>
