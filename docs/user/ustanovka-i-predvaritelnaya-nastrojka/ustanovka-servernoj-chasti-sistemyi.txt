
.. _ustanovka-i-predvaritelnaya-nastrojka-ustanovka-servernoj-chasti-sistemyi:

=====================================
3.4 Установка серверной части системы
=====================================


Для установки системы необходим сервер на базе ОС Linux. Необходимые
зависимости:



postgresql-8.3

postgresql-common

postgresql-contrib

ssh



Также настоятельно рекомендуется установить системную локаль в ru_RU.UTF-8.



Описание установки серверной части системы на другие серверы доступа выходит
за рамки этого руководства – обратитесь к руководству пользователя
соответствующего сервера доступа.



Рассмотрим установку серверной части Expert Billing System на примере Debian
Lenny.



1. Создаём необходимую структуру директорий



mkdir /opt/ebs
mkdir /opt/ebs/data/
cd /opt/ebs/data



2. Копируем в этот каталог архив с биллингом и распаковываем его



tar -xzvf ebs-1.03.tar.gz



2. Создаем пользователя:



adduser ebs



Пароль – ebsuser (можно изменить на желаемый)



3. Создаем базу данных (БД):



apt-get install postgresql-8.3 postgresql-contrib-8.3

su postgres
createuser -P –s ebs
createdb –O ebs ebs

exit

su ebs
psql ebs -f /usr/share/postgresql/8.3/contrib/_int.sql
psql ebs –f /usr/share/postgresql/8.3/contrib/int_aggregate.sql

exit



Обратите внимание: в том случае, если вы используете более новую версию СУБД
PostgreSQL, пути к библиотекам у вас могут выглядеть соответственно

psql ebs -f /usr/share/postgresql/8.4/contrib/_int.sql

psql ebs -f /usr/share/postgresql/8.4/contrib/int.sql

psql ebs –f /usr/share/postgresql/8.4/contrib/int_aggregate.sql

Обратите внимание: база данных СУБД PostgreSQL по умолчанию находится в
каталоге /var/. Рекомендуется эту точку монтирования вынести на отдельный
раздел, а также предоставить ей максимальное количество дискового
пространства, либо выделить отдельный жесткий диск.



4. Импортируем дамп БД:



su ebs
psql ebs -f /opt/ebs/data/sql/ebs_dump.sql

psql ebs -f /opt/ebs/data/sql/changes.sql



Обратите внимание: первый файл (ebs_dump.sql) содержит схему базы данных. В
файле changes.sql находятся все новые изменения, которые не попали в основной
дамп. Импортирование файла chganges.sql СТРОГО обязательно. Во время
импортирования возможно появление предупреждений и ошибок, о уже существующих
методах или операциях.



5. Прописываем скрипты инициализации:



 cp /opt/ebs/data/init.d/ebs_core /etc/init.d/ebs_core
 cp /opt/ebs/data/init.d/ebs_rad /etc/init.d/ebs_rad
 cp /opt/ebs/data/init.d/ebs_nf /etc/init.d/ebs_nf
 cp /opt/ebs/data/init.d/ebs_nfroutine /etc/init.d/ebs_nfroutine
 cp /opt/ebs/data/init.d/ebs_rpc /etc/init.d/ebs_rpc



 update-rc.d ebs_core defaults
 update-rc.d ebs_rad defaults
 update-rc.d ebs_nf defaults
 update-rc.d ebs_nfroutine defaults
 update-rc.d ebs_rpc defaults



6. Настраиваем подключение к базе данных



Открываем ebs_config.ini из директории с биллингом и указываем параметры для
подключения к базе данных.



7. Производим тестовый запуск Expert Billing Admin


Запустим RPC сервер:



 cd /opt/ebs/data/
 ./rpc



Сейчас откройте EBSClient, укажите IP-адрес сервера с биллингом, имя admin,
пароль admin, и попробуйте подключиться.



8. Настройка сервера доступа



Для начала необходимо настроить экспорт сетевой статистики на сервере доступа
под управлением MikroTik следующим образом:



.. image:: _images/ebs_030.png
    :alt: ebs_030




.. image:: _images/ebs_031.png
    :alt: ebs_031




.. image:: _images/ebs_032.png
    :alt: ebs_032




/ip traffic-flow set enabled=yes
/ip traffic-flow target add disabled=no version=5 address=<адрес  сервера с
биллингом>



9. Включаем RADIUS-авторизацию



/radius add address=<IP сервера с билингом> secret=123 service=ppp
timeout=1000



Для включения RADIUS авторизации PPTP/PPPOE/DHCP-сессий необходимо:



•Добавить новый PPP-профиль



.. image:: _images/ebs_040.png
    :alt: ebs_040




•Включить PPTP-сервер с созданным профилем



.. image:: _images/ebs_041.png
    :alt: ebs_041




•Включаем RADIUS авторизацию и аккаунтинг для PPTP



.. image:: _images/ebs_042.png
    :alt: ebs_042




.. image:: _images/ebs_044.png
    :alt: ebs_044




•Меняем идентификатор сервера доступа на MikroTik_NAS.



.. image:: _images/ebs_045.png
    :alt: ebs_045




10. Включаем DHCP-сервер (только в случае если планируется использовать
    MikroTik для выдачи IP-адресов с авторизацией на биллинг-системе)



.. image:: _images/ebs_050.png
    :alt: ebs_050




.. image:: _images/ebs_051.png
    :alt: ebs_051




11. Создаем системного пользователя ebs с паролем ebspassword или любым
    другим:



.. image:: _images/ebs_060.png
    :alt: ebs_060




12. Настраиваем файервол:



Разрешим серверу доступа пропускать через себя пакеты на адреса виртуальной
сети и запретим всё остальное:



 /ip  firewall filter add src-address=192.168.12.0/24 action=accept
 /ip  firewall filter add dst-address=192.168.12.0/24 action=accept
 /ip  firewall filter add action=drop

Если клиентам не будут выдаваться реальные IP-адреса, необходимо настроить
NAT или MASQUERADING. Создаем правило:



 /ip firewall nat add src-address=192.168.12.0/24 action=masquerade



Обратите внимание: в целях безопасности рекомендуется разрешить
взаимодействие сервера с биллингом только с сервером (серверами) доступа,
компьютером администратора и компьютером кассира, а также открыть 80 порт для
корректной работы веб-кабинета.



13. Производим настройку кэширующего DNS-сервера:



.. image:: _images/ebs_070.png
    :alt: ebs_070




.. image:: _images/ebs_071.png
    :alt: ebs_071




Установка завершена.



